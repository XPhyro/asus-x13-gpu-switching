#!/bin/bash

isroot=false

if [ ! -z "$SUDO_USER" ]; then
  isroot=true
fi

if [ "$EUID" -ne 0 ]; then
  isroot=true
fi

if [ $isroot = "false" ]; then
  echo "root / sudo user expected, exiting"
  exit 1
fi

GPUFILE=/etc/asus_nvidia

if [ -f $GPUFILE ]; then
  echo "$GPUFILE exists."
  GPUFILEPRESENT=true
else
  echo "$GPUFILE does not exist."
  GPUFILEPRESENT=false
fi

if [ $GPUFILEPRESENT = "true" ]; then
  echo "activating and loading Nvidia"
  modprobe nvidia_uvm
  modprobe nvidia_drm
  modprobe nvidia_modeset
  modprobe nvidia
  powerprofilesctl set balanced
else
  echo "deactivating nvidia"
  echo 1 > /sys/bus/pci/devices/0000\:01\:00.0/remove
  echo 'auto' > /sys/bus/pci/devices/0000\:01\:00.0/power/control
  # sh -c 'echo "\\_SB.PCI0.GPP0.PG00._OFF" > /proc/acpi/call'
fi

exit 0