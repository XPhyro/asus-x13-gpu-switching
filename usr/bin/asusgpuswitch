#!/bin/bash

GPUDISABLED=$(cat /sys/devices/platform/asus-nb-wmi/dgpu_disable)

if [ $GPUDISABLED = "0" ]; then
  echo "stopping DM"

  systemctl stop display-manager
  sleep 5

  echo "removing nvidia kernel modules"
  rmmod nvidia_uvm
  rmmod nvidia_drm
  rmmod nvidia_modeset
  rmmod nvidia
  sleep 1
  
  # no effect on dynamic power management later
  # thought it might have when not "properly" removed
  # echo 1 > /sys/devices/pci0000:00/0000:00:01.0/remove
  # echo 1 > /sys/devices/pci0000:00/0000:00:01.1/remove
  # sleep 1
  
  echo 1 > /sys/devices/platform/asus-nb-wmi/dgpu_disable
  sleep 1
    
  echo "rescanning bus"
  echo 1 > /sys/bus/pci/rescan
  sleep 1

  echo "restarting display manager"
  systemctl restart display-manager.service
else
  echo "stopping DM"
  systemctl stop display-manager.service
  sleep 5

  echo "asus-nb-wmi/dgpu_disable is set, enabling..."
  echo 0 > /sys/devices/platform/asus-nb-wmi/dgpu_disable
  sleep 1
    
  echo "rescanning bus"
  echo 1 > /sys/bus/pci/rescan
  sleep 1

  echo "loading nvidia kernel modules"
  modprobe nvidia "NVreg_DynamicPowerManagement=0x02"
  sleep 1

  echo "restarting display manager"
  systemctl restart display-manager.service
fi
