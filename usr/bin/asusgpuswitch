#!/bin/bash

GPUDISABLED=$(cat /sys/devices/platform/asus-nb-wmi/dgpu_disable)

if [ $GPUDISABLED = "0" ]; then
  echo "stopping DM"

  systemctl stop display-manager
  sleep 5

  echo "removing nvidia kernel modules"
  rmmod nvidia_uvm
  rmmod nvidia_drm
  rmmod nvidia_modeset
  rmmod nvidia
  sleep 1
  
  echo "calling asus-nb-wmi/dgpu_disable 1 for the first time..."
  echo 1 > /sys/devices/platform/asus-nb-wmi/dgpu_disable
  
  echo "rescanning bus"
  echo 1 > /sys/bus/pci/rescan

  echo "calling asus-nb-wmi/dgpu_disable 1 a second time..."
  echo 1 > /sys/devices/platform/asus-nb-wmi/dgpu_disable

  echo "restarting display manager"
  systemctl restart display-manager.service
else
  echo "stopping DM"
  systemctl stop display-manager.service
  sleep 5

  echo "asus-nb-wmi/dgpu_disable is set, enabling..."
  echo 0 > /sys/devices/platform/asus-nb-wmi/dgpu_disable
    
  echo "rescanning bus"
  echo 1 > /sys/bus/pci/rescan
  
  echo "calling asus-nb-wmi/dgpu_disable 0 a second time..."
  echo 0 > /sys/devices/platform/asus-nb-wmi/dgpu_disable

  echo "loading nvidia kernel modules"
  modprobe nvidia "NVreg_DynamicPowerManagement=0x02"
  modprobe nvidia_drm
  modprobe nvidia_modeset
  sleep 1

  echo "restarting display manager"
  systemctl restart display-manager.service
fi

exit 0
