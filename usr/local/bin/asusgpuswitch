#!/usr/bin/env sh

GPUFILE=/etc/asus_nvidia

if [ -f "$GPUFILE" ]; then
    printf "%s\n" "removing nvidia kernel modules"
    rmmod nvidia_uvm
    rmmod nvidia_drm
    rmmod nvidia_modeset
    rmmod nvidia
  
    sleep 1
  
    printf "%s\n" "acpi_call to power off the dGPU"
    printf "%s\n" 1 > /sys/bus/pci/devices/0000\:01\:00.0/remove
  
    sleep 1
  
    printf "%s\n" "removing /etc/asus_nvidia"
    rm -- "$GPUFILE"
else
    printf "%s\n" "acpi_call to power on the dGPU"
    printf "%s\n" 1 > /sys/bus/pci/rescan
    sleep 1
  
    printf "%s\n" "loading nvidia kernel modules"
    modprobe nvidia_uvm
    modprobe nvidia_drm
    modprobe nvidia_modeset
    modprobe nvidia
  
    printf "%s\n" "setting nvidia power/control auto"
    printf "%s\n" 'auto' > /sys/bus/pci/devices/0000\:01\:00.0/power/control
  
    printf "%s\n" "setting $GPUFILE"
    touch -- "$GPUFILE"
fi
